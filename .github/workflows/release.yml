name: Release

on:
  release:
    types: [created]

jobs:
  build-vsix:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          experimental: true

      - name: Set version from tag
        run: npm version "${GITHUB_REF_NAME#v}" --no-git-tag-version

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

      - name: Type check
        run: bun run typecheck

      - name: Unit tests
        run: bun run test

      - name: Build
        run: bun run build

      - name: Verify licenses are up to date
        run: |
          bun run licenses:generate
          git diff --exit-code ThirdPartyNotices.txt

      - name: Package .vsix
        run: bun run package

      - name: Upload .vsix to release
        run: gh release upload "${{ github.event.release.tag_name }}" *.vsix
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Publish to VS Code Marketplace
        run: npx vsce publish --packagePath *.vsix
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX
        run: npx ovsx publish *.vsix -p ${{ secrets.OVSX_PAT }}

      - name: Push version bump to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "Bump version to ${GITHUB_REF_NAME#v}"
          git push origin HEAD:main
